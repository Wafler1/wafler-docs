'use client';

import { highlight } from "./index.js";
import { createContext, use, useEffect, useMemo, useRef, useState } from "react";
import { jsx } from "react/jsx-runtime";

//#region src/highlight/core/client.tsx
const ShikiConfigContext = createContext(null);
function useShikiConfigOptional() {
	return use(ShikiConfigContext);
}
function useShikiConfig(forced) {
	if (forced) return forced;
	const ctx = use(ShikiConfigContext);
	if (!ctx) throw new Error(`missing <ShikiConfigProvider />`);
	return ctx;
}
function ShikiConfigProvider({ config, children }) {
	return /* @__PURE__ */ jsx(ShikiConfigContext, {
		value: config,
		children
	});
}
const promises = {};
/**
* get highlighted results (uncached), use `useEffect` instead of React 19 APIs.
*/
function useShikiDynamic(code, options, deps) {
	const [node, setNode] = useState(options.defaultValue);
	const config = useShikiConfig(options.config);
	const lastTask = useRef(null);
	useEffect(() => {
		const promise = highlight(code, {
			...options,
			config
		});
		lastTask.current = promise;
		promise.then((res) => {
			if (lastTask.current === promise) setNode(res);
		});
		return () => {
			lastTask.current = null;
		};
	}, deps);
	return node;
}
/**
* get highlighted results, should be used with React Suspense API.
*
* note: results are cached with (lang, code) as keys, if this is not the desired behaviour, pass a `deps` instead.
*/
function useShiki(code, options, deps) {
	const config = useShikiConfig(options.config);
	const key = useMemo(() => {
		return deps ? JSON.stringify(deps) : `${options.lang}:${code}`;
	}, [
		code,
		deps,
		options.lang
	]);
	return use(promises[key] ??= highlight(code, {
		...options,
		config
	}));
}

//#endregion
export { ShikiConfigProvider, useShiki, useShikiConfig, useShikiConfigOptional, useShikiDynamic };