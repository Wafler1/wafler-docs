{"version":3,"sources":["../../../src/lib/utils/render.ts"],"sourcesContent":["import type {\n  Unstable_ParseRsc,\n  Unstable_RenderHtml,\n  Unstable_RenderRsc,\n} from '../types.js';\n\nexport function createRenderUtils(\n  temporaryReferences: unknown,\n  renderToReadableStream: (\n    data: unknown,\n    options?: object,\n    extraOptions?: object,\n  ) => ReadableStream,\n  createFromReadableStream: (\n    stream: ReadableStream,\n    options?: object,\n  ) => Promise<unknown>,\n  loadSsrEntryModule: () => Promise<\n    typeof import('../vite-entries/entry.ssr.js')\n  >,\n): {\n  renderRsc: Unstable_RenderRsc;\n  parseRsc: Unstable_ParseRsc;\n  renderHtml: Unstable_RenderHtml;\n} {\n  const onError = (e: unknown) => {\n    console.error('Error during rendering:', e);\n    if (\n      e &&\n      typeof e === 'object' &&\n      'digest' in e &&\n      typeof e.digest === 'string'\n    ) {\n      return e.digest;\n    }\n  };\n\n  return {\n    async renderRsc(elements, options) {\n      return renderToReadableStream(\n        elements,\n        {\n          temporaryReferences,\n          onError,\n        },\n        {\n          onClientReference(metadata: {\n            id: string;\n            name: string;\n            deps: { js: string[]; css: string[] };\n          }) {\n            options?.unstable_clientModuleCallback?.(metadata.deps.js);\n          },\n        },\n      );\n    },\n    async parseRsc(stream) {\n      return createFromReadableStream(stream, {}) as Promise<\n        Record<string, unknown>\n      >;\n    },\n    async renderHtml(elementsStream, html, options) {\n      const { INTERNAL_renderHtmlStream: renderHtmlStream } =\n        await loadSsrEntryModule();\n\n      const rscHtmlStream = renderToReadableStream(html, {\n        onError,\n      });\n      const htmlResult = await renderHtmlStream(elementsStream, rscHtmlStream, {\n        rscPath: options.rscPath,\n        formState: options.formState as never,\n        nonce: options.nonce,\n        extraScriptContent: options.unstable_extraScriptContent,\n      });\n      return new Response(htmlResult.stream, {\n        status: htmlResult.status || options.status || 200,\n        headers: { 'content-type': 'text/html' },\n      });\n    },\n  };\n}\n"],"names":["createRenderUtils","temporaryReferences","renderToReadableStream","createFromReadableStream","loadSsrEntryModule","onError","e","console","error","digest","renderRsc","elements","options","onClientReference","metadata","unstable_clientModuleCallback","deps","js","parseRsc","stream","renderHtml","elementsStream","html","INTERNAL_renderHtmlStream","renderHtmlStream","rscHtmlStream","htmlResult","rscPath","formState","nonce","extraScriptContent","unstable_extraScriptContent","Response","status","headers"],"mappings":"AAMA,OAAO,SAASA,kBACdC,mBAA4B,EAC5BC,sBAImB,EACnBC,wBAGqB,EACrBC,kBAEC;IAMD,MAAMC,UAAU,CAACC;QACfC,QAAQC,KAAK,CAAC,2BAA2BF;QACzC,IACEA,KACA,OAAOA,MAAM,YACb,YAAYA,KACZ,OAAOA,EAAEG,MAAM,KAAK,UACpB;YACA,OAAOH,EAAEG,MAAM;QACjB;IACF;IAEA,OAAO;QACL,MAAMC,WAAUC,QAAQ,EAAEC,OAAO;YAC/B,OAAOV,uBACLS,UACA;gBACEV;gBACAI;YACF,GACA;gBACEQ,mBAAkBC,QAIjB;oBACCF,SAASG,gCAAgCD,SAASE,IAAI,CAACC,EAAE;gBAC3D;YACF;QAEJ;QACA,MAAMC,UAASC,MAAM;YACnB,OAAOhB,yBAAyBgB,QAAQ,CAAC;QAG3C;QACA,MAAMC,YAAWC,cAAc,EAAEC,IAAI,EAAEV,OAAO;YAC5C,MAAM,EAAEW,2BAA2BC,gBAAgB,EAAE,GACnD,MAAMpB;YAER,MAAMqB,gBAAgBvB,uBAAuBoB,MAAM;gBACjDjB;YACF;YACA,MAAMqB,aAAa,MAAMF,iBAAiBH,gBAAgBI,eAAe;gBACvEE,SAASf,QAAQe,OAAO;gBACxBC,WAAWhB,QAAQgB,SAAS;gBAC5BC,OAAOjB,QAAQiB,KAAK;gBACpBC,oBAAoBlB,QAAQmB,2BAA2B;YACzD;YACA,OAAO,IAAIC,SAASN,WAAWP,MAAM,EAAE;gBACrCc,QAAQP,WAAWO,MAAM,IAAIrB,QAAQqB,MAAM,IAAI;gBAC/CC,SAAS;oBAAE,gBAAgB;gBAAY;YACzC;QACF;IACF;AACF"}