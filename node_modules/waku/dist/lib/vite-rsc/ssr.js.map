{"version":3,"sources":["../../../src/lib/vite-rsc/ssr.tsx"],"sourcesContent":["import { type ReactNode, captureOwnerStack, use } from 'react';\nimport { createFromReadableStream } from '@vitejs/plugin-rsc/ssr';\nimport type { ReactFormState } from 'react-dom/client';\nimport { renderToReadableStream } from 'react-dom/server.edge';\nimport { injectRSCPayload } from 'rsc-html-stream/server';\nimport fallbackHtml from 'virtual:vite-rsc-waku/fallback-html';\nimport { INTERNAL_ServerRoot } from '../../minimal/client.js';\nimport { getErrorInfo } from '../utils/custom-errors.js';\nimport { getBootstrapPreamble } from '../utils/ssr.js';\nimport { batchReadableStream } from '../utils/stream.js';\n\ntype RenderHtmlStream = (\n  rscStream: ReadableStream<Uint8Array>,\n  rscHtmlStream: ReadableStream<Uint8Array>,\n  options: {\n    rscPath: string | undefined;\n    formState: ReactFormState | undefined;\n    nonce: string | undefined;\n    extraScriptContent: string | undefined;\n  },\n) => Promise<{ stream: ReadableStream; status: number | undefined }>;\n\ntype RscElementsPayload = Record<string, unknown>;\ntype RscHtmlPayload = ReactNode;\n\n// This code runs on `ssr` environment,\n// i.e. it runs on server but without `react-server` condition.\n// These utilities are used by `rsc` environment through\n// `import.meta.viteRsc.loadModule` API.\n\nexport const renderHtmlStream: RenderHtmlStream = async (\n  rscStream,\n  rscHtmlStream,\n  options,\n) => {\n  const [stream1, stream2] = rscStream.tee();\n\n  let elementsPromise: Promise<RscElementsPayload>;\n  let htmlPromise: Promise<RscHtmlPayload>;\n\n  // deserialize RSC stream back to React VDOM\n  function SsrRoot() {\n    // RSC stream needs to be deserialized inside SSR component.\n    // This is for ReactDomServer preinit/preload (e.g. client reference modulepreload, css)\n    // https://github.com/facebook/react/pull/31799#discussion_r1886166075\n    elementsPromise ??= createFromReadableStream<RscElementsPayload>(stream1);\n    htmlPromise ??= createFromReadableStream<RscHtmlPayload>(rscHtmlStream);\n    return (\n      <INTERNAL_ServerRoot elementsPromise={elementsPromise}>\n        {use(htmlPromise)}\n      </INTERNAL_ServerRoot>\n    );\n  }\n\n  // render html\n  const bootstrapScriptContent = await loadBootstrapScriptContent();\n  let htmlStream: ReadableStream;\n  let status: number | undefined;\n  try {\n    htmlStream = await renderToReadableStream(<SsrRoot />, {\n      bootstrapScriptContent:\n        getBootstrapPreamble({\n          rscPath: options.rscPath || '',\n          hydrate: true,\n        }) +\n        bootstrapScriptContent +\n        (options.extraScriptContent || ''),\n      onError: (e: unknown) => {\n        if (\n          e &&\n          typeof e === 'object' &&\n          'digest' in e &&\n          typeof e.digest === 'string'\n        ) {\n          return e.digest;\n        }\n        console.error('[SSR Error]', captureOwnerStack?.() || '', '\\n', e);\n      },\n      ...(options.nonce ? { nonce: options.nonce } : {}),\n      ...(options.formState ? { formState: options.formState } : {}),\n    });\n  } catch (e) {\n    const info = getErrorInfo(e);\n    if (info?.location) {\n      // keep unstable_redirect error as http redirection\n      throw e;\n    }\n    status = info?.status || 500;\n    // SSR empty html and go full CSR on browser, which can revive RSC errors.\n    const ssrErrorRoot = (\n      <html>\n        <body></body>\n      </html>\n    );\n    htmlStream = await renderToReadableStream(ssrErrorRoot, {\n      bootstrapScriptContent:\n        getBootstrapPreamble({\n          rscPath: options.rscPath || '',\n          hydrate: false,\n        }) +\n        bootstrapScriptContent +\n        (options.extraScriptContent || ''),\n      ...(options.nonce ? { nonce: options.nonce } : {}),\n    });\n  }\n  let responseStream: ReadableStream<Uint8Array> = htmlStream;\n  responseStream = responseStream.pipeThrough(\n    injectRSCPayload(\n      batchReadableStream(stream2),\n      options.nonce ? { nonce: options.nonce } : {},\n    ),\n  );\n\n  return { stream: responseStream, status };\n};\n\nexport async function renderHtmlFallback() {\n  const bootstrapScriptContent = await loadBootstrapScriptContent();\n  const html = fallbackHtml.replace(\n    '</body>',\n    () => `<script>${bootstrapScriptContent}</script></body>`,\n  );\n  return html;\n}\n\nfunction loadBootstrapScriptContent(): Promise<string> {\n  return import.meta.viteRsc.loadBootstrapScriptContent('index');\n}\n"],"names":["captureOwnerStack","use","createFromReadableStream","renderToReadableStream","injectRSCPayload","fallbackHtml","INTERNAL_ServerRoot","getErrorInfo","getBootstrapPreamble","batchReadableStream","renderHtmlStream","rscStream","rscHtmlStream","options","stream1","stream2","tee","elementsPromise","htmlPromise","SsrRoot","bootstrapScriptContent","loadBootstrapScriptContent","htmlStream","status","rscPath","hydrate","extraScriptContent","onError","e","digest","console","error","nonce","formState","info","location","ssrErrorRoot","html","body","responseStream","pipeThrough","stream","renderHtmlFallback","replace","viteRsc"],"mappings":";AAAA,SAAyBA,iBAAiB,EAAEC,GAAG,QAAQ,QAAQ;AAC/D,SAASC,wBAAwB,QAAQ,yBAAyB;AAElE,SAASC,sBAAsB,QAAQ,wBAAwB;AAC/D,SAASC,gBAAgB,QAAQ,yBAAyB;AAC1D,OAAOC,kBAAkB,sCAAsC;AAC/D,SAASC,mBAAmB,QAAQ,0BAA0B;AAC9D,SAASC,YAAY,QAAQ,4BAA4B;AACzD,SAASC,oBAAoB,QAAQ,kBAAkB;AACvD,SAASC,mBAAmB,QAAQ,qBAAqB;AAgBzD,uCAAuC;AACvC,+DAA+D;AAC/D,wDAAwD;AACxD,wCAAwC;AAExC,OAAO,MAAMC,mBAAqC,OAChDC,WACAC,eACAC;IAEA,MAAM,CAACC,SAASC,QAAQ,GAAGJ,UAAUK,GAAG;IAExC,IAAIC;IACJ,IAAIC;IAEJ,4CAA4C;IAC5C,SAASC;QACP,4DAA4D;QAC5D,wFAAwF;QACxF,sEAAsE;QACtEF,oBAAoBf,yBAA6CY;QACjEI,gBAAgBhB,yBAAyCU;QACzD,qBACE,KAACN;YAAoBW,iBAAiBA;sBACnChB,IAAIiB;;IAGX;IAEA,cAAc;IACd,MAAME,yBAAyB,MAAMC;IACrC,IAAIC;IACJ,IAAIC;IACJ,IAAI;QACFD,aAAa,MAAMnB,qCAAuB,KAACgB,cAAY;YACrDC,wBACEZ,qBAAqB;gBACnBgB,SAASX,QAAQW,OAAO,IAAI;gBAC5BC,SAAS;YACX,KACAL,yBACCP,CAAAA,QAAQa,kBAAkB,IAAI,EAAC;YAClCC,SAAS,CAACC;gBACR,IACEA,KACA,OAAOA,MAAM,YACb,YAAYA,KACZ,OAAOA,EAAEC,MAAM,KAAK,UACpB;oBACA,OAAOD,EAAEC,MAAM;gBACjB;gBACAC,QAAQC,KAAK,CAAC,eAAe/B,yBAAyB,IAAI,MAAM4B;YAClE;YACA,GAAIf,QAAQmB,KAAK,GAAG;gBAAEA,OAAOnB,QAAQmB,KAAK;YAAC,IAAI,CAAC,CAAC;YACjD,GAAInB,QAAQoB,SAAS,GAAG;gBAAEA,WAAWpB,QAAQoB,SAAS;YAAC,IAAI,CAAC,CAAC;QAC/D;IACF,EAAE,OAAOL,GAAG;QACV,MAAMM,OAAO3B,aAAaqB;QAC1B,IAAIM,MAAMC,UAAU;YAClB,mDAAmD;YACnD,MAAMP;QACR;QACAL,SAASW,MAAMX,UAAU;QACzB,0EAA0E;QAC1E,MAAMa,6BACJ,KAACC;sBACC,cAAA,KAACC;;QAGLhB,aAAa,MAAMnB,uBAAuBiC,cAAc;YACtDhB,wBACEZ,qBAAqB;gBACnBgB,SAASX,QAAQW,OAAO,IAAI;gBAC5BC,SAAS;YACX,KACAL,yBACCP,CAAAA,QAAQa,kBAAkB,IAAI,EAAC;YAClC,GAAIb,QAAQmB,KAAK,GAAG;gBAAEA,OAAOnB,QAAQmB,KAAK;YAAC,IAAI,CAAC,CAAC;QACnD;IACF;IACA,IAAIO,iBAA6CjB;IACjDiB,iBAAiBA,eAAeC,WAAW,CACzCpC,iBACEK,oBAAoBM,UACpBF,QAAQmB,KAAK,GAAG;QAAEA,OAAOnB,QAAQmB,KAAK;IAAC,IAAI,CAAC;IAIhD,OAAO;QAAES,QAAQF;QAAgBhB;IAAO;AAC1C,EAAE;AAEF,OAAO,eAAemB;IACpB,MAAMtB,yBAAyB,MAAMC;IACrC,MAAMgB,OAAOhC,aAAasC,OAAO,CAC/B,WACA,IAAM,CAAC,QAAQ,EAAEvB,uBAAuB,gBAAgB,CAAC;IAE3D,OAAOiB;AACT;AAEA,SAAShB;IACP,OAAO,YAAYuB,OAAO,CAACvB,0BAA0B,CAAC;AACxD"}