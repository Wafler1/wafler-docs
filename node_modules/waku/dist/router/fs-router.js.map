{"version":3,"sources":["../../src/router/fs-router.ts"],"sourcesContent":["import type { FunctionComponent, ReactNode } from 'react';\nimport type { ImportGlobFunction } from 'vite/types/importGlob.d.ts';\nimport { isIgnoredPath } from '../lib/utils/fs-router.js';\nimport { METHODS, createPages } from './create-pages.js';\nimport type { Method } from './create-pages.js';\n\ndeclare global {\n  interface ImportMeta {\n    glob: ImportGlobFunction;\n  }\n}\n\nlet didWarnAboutApiDirMigration = false;\n\nexport function fsRouter(\n  /**\n   * A mapping from a file path to a route module, e.g.\n   *   {\n   *     \"_layout.tsx\": () => ({ default: ... }),\n   *     \"index.tsx\": () => ({ default: ... }),\n   *     \"foo/index.tsx\": () => ...,\n   *   }\n   * This mapping can be created by Vite's import.meta.glob, e.g.\n   *   import.meta.glob(\"./**\\/*.{tsx,ts}\", { base: \"./pages\" })\n   */\n  pages: { [file: string]: () => Promise<unknown> },\n  options: {\n    /** e.g. `\"_api\"` will detect pages in `src/pages/_api` and strip `_api` from the path. */\n    apiDir: string;\n    /** e.g. `\"_slices\"` will detect slices in `src/pages/_slices`. */\n    slicesDir: string;\n  } = {\n    apiDir: '_api',\n    slicesDir: '_slices',\n  },\n) {\n  if (\n    !didWarnAboutApiDirMigration &&\n    !(options as any).temporary_doNotWarnAboutApiDirMigration\n  ) {\n    didWarnAboutApiDirMigration = true;\n    // TODO: remove this warning after a few versions\n    if (Object.keys(pages).some((file) => file.startsWith('./api/'))) {\n      console.warn(\n        '[fsRouter] Migration required (v1.0.0-alpha.1): Move \"./api/\" to \"./_api/\". To preserve the old \"/api/*\" URL paths, move to \"./_api/api/\". See https://github.com/wakujs/waku/pull/1885',\n      );\n    }\n  }\n  return createPages(\n    async ({\n      createPage,\n      createLayout,\n      createRoot,\n      createApi,\n      createSlice,\n    }) => {\n      for (let file in pages) {\n        const mod = (await pages[file]!()) as {\n          default: FunctionComponent<{ children: ReactNode }>;\n          getConfig?: () => Promise<{\n            render?: 'static' | 'dynamic';\n          }>;\n          GET?: (req: Request) => Promise<Response>;\n        };\n        // strip \"./\" prefix\n        file = file.replace(/^\\.\\//, '');\n        const config = await mod.getConfig?.();\n        const pathItems = file\n          .replace(/\\.\\w+$/, '')\n          .split('/')\n          .filter(Boolean);\n        if (isIgnoredPath(pathItems)) {\n          continue;\n        }\n        const path =\n          '/' +\n          (['_layout', 'index', '_root'].includes(pathItems.at(-1)!) ||\n          pathItems.at(-1)?.startsWith('_part')\n            ? pathItems.slice(0, -1)\n            : pathItems\n          ).join('/');\n        if (pathItems.at(-1) === '[path]') {\n          throw new Error(\n            'Page file cannot be named [path]. This will conflict with the path prop of the page component.',\n          );\n        } else if (pathItems.at(0) === options.apiDir) {\n          // Strip the apiDir prefix from the path (e.g., _api/hello.txt -> hello.txt)\n          const apiPath = pathItems.slice(1).join('/');\n          if (config?.render === 'static') {\n            if (Object.keys(mod).length !== 2 || !mod.GET) {\n              console.warn(\n                `API ${path} is invalid. For static API routes, only a single GET handler is supported.`,\n              );\n            }\n            createApi({\n              ...config,\n              path: apiPath,\n              render: 'static',\n              method: 'GET',\n              handler: mod.GET!,\n            });\n          } else {\n            const validMethods = new Set(METHODS);\n            const handlers = Object.fromEntries(\n              Object.entries(mod).flatMap(([exportName, handler]) => {\n                const isValidExport =\n                  exportName === 'getConfig' ||\n                  exportName === 'default' ||\n                  validMethods.has(exportName as Method);\n                if (!isValidExport) {\n                  console.warn(\n                    `API ${path} has an invalid export: ${exportName}. Valid exports are: ${METHODS.join(\n                      ', ',\n                    )}`,\n                  );\n                }\n                return isValidExport && exportName !== 'getConfig'\n                  ? exportName === 'default'\n                    ? [['all', handler]]\n                    : [[exportName, handler]]\n                  : [];\n              }),\n            );\n            createApi({\n              path: apiPath,\n              render: 'dynamic',\n              handlers,\n            });\n          }\n        } else if (pathItems.at(0) === options.slicesDir) {\n          createSlice({\n            component: mod.default,\n            render: 'static',\n            id: pathItems.slice(1).join('/'),\n            ...config,\n          });\n        } else if (pathItems.at(-1) === '_layout') {\n          createLayout({\n            path,\n            component: mod.default,\n            render: 'static',\n            ...config,\n          });\n        } else if (pathItems.at(-1) === '_root') {\n          createRoot({\n            component: mod.default,\n            render: 'static',\n            ...config,\n          });\n        } else {\n          createPage({\n            path,\n            component: mod.default,\n            render: 'static',\n            ...config,\n          } as never); // FIXME avoid as never\n        }\n      }\n      // HACK: to satisfy the return type, unused at runtime\n      return null as never;\n    },\n  );\n}\n"],"names":["isIgnoredPath","METHODS","createPages","didWarnAboutApiDirMigration","fsRouter","pages","options","apiDir","slicesDir","temporary_doNotWarnAboutApiDirMigration","Object","keys","some","file","startsWith","console","warn","createPage","createLayout","createRoot","createApi","createSlice","mod","replace","config","getConfig","pathItems","split","filter","Boolean","path","includes","at","slice","join","Error","apiPath","render","length","GET","method","handler","validMethods","Set","handlers","fromEntries","entries","flatMap","exportName","isValidExport","has","component","default","id"],"mappings":"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"}