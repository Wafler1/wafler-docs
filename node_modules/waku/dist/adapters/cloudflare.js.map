{"version":3,"sources":["../../src/adapters/cloudflare.ts"],"sourcesContent":["import { Hono } from 'hono';\nimport type { MiddlewareHandler } from 'hono';\nimport {\n  unstable_constants as constants,\n  unstable_createServerEntryAdapter as createServerEntryAdapter,\n  unstable_honoMiddleware as honoMiddleware,\n} from 'waku/internals';\nimport type { BuildOptions } from './cloudflare-build-enhancer.js';\n\nconst { DIST_PUBLIC } = constants;\nconst { contextMiddleware, rscMiddleware, middlewareRunner } = honoMiddleware;\n\nfunction isWranglerDev(req: Request): boolean {\n  // This header seems to only be set for production cloudflare workers\n  return !req.headers.get('cf-visitor');\n}\n\nfunction removeGzipEncoding(res: Response): Response {\n  const contentType = res.headers.get('content-type');\n  if (\n    !contentType ||\n    contentType.includes('text/html') ||\n    contentType.includes('text/plain')\n  ) {\n    const headers = new Headers(res.headers);\n    headers.set('content-encoding', 'Identity');\n    return new Response(res.body, {\n      status: res.status,\n      statusText: res.statusText,\n      headers,\n    });\n  }\n  return res;\n}\n\nexport default createServerEntryAdapter(\n  (\n    { processRequest, processBuild, config, notFoundHtml },\n    options?: {\n      static?: boolean;\n      handlers?: Record<string, unknown>;\n      assetsDir?: string;\n      middlewareFns?: (() => MiddlewareHandler)[];\n      middlewareModules?: Record<string, () => Promise<unknown>>;\n    },\n  ) => {\n    const { middlewareFns = [], middlewareModules = {} } = options || {};\n    const app = new Hono();\n    app.notFound((c) => {\n      if (notFoundHtml) {\n        return c.html(notFoundHtml, 404);\n      }\n      return c.text('404 Not Found', 404);\n    });\n    app.use(contextMiddleware());\n    for (const middlewareFn of middlewareFns) {\n      app.use(middlewareFn());\n    }\n    app.use(middlewareRunner(middlewareModules as never));\n    app.use(rscMiddleware({ processRequest }));\n    const buildOptions: BuildOptions = {\n      assetsDir: options?.assetsDir || 'assets',\n      distDir: config.distDir,\n      privateDir: config.privateDir,\n      rscBase: config.rscBase,\n      basePath: config.basePath,\n      DIST_PUBLIC,\n      serverless: !options?.static,\n    };\n\n    return {\n      fetch: async (req: Request) => {\n        let cloudflareContext;\n        try {\n          // @ts-expect-error - available when running in a Cloudflare environment\n          // eslint-disable-next-line import/no-unresolved\n          cloudflareContext = await import('cloudflare:workers');\n        } catch {\n          // Not in a Cloudflare environment\n        }\n        let res: Response | Promise<Response>;\n        if (cloudflareContext) {\n          const { env, waitUntil, passThroughOnException } = cloudflareContext;\n          res = app.fetch(req, env, {\n            waitUntil,\n            passThroughOnException,\n            props: undefined,\n          });\n        } else {\n          res = app.fetch(req);\n        }\n        // Workaround https://github.com/cloudflare/workers-sdk/issues/6577\n        if (import.meta.env?.PROD && isWranglerDev(req)) {\n          if ('then' in res) {\n            res = res.then((res) => removeGzipEncoding(res));\n          } else {\n            res = removeGzipEncoding(res);\n          }\n        }\n        return res;\n      },\n      handlers: options?.handlers,\n      build: processBuild,\n      buildOptions,\n      buildEnhancers: ['waku/adapters/cloudflare-build-enhancer'],\n    };\n  },\n);\n"],"names":["Hono","unstable_constants","constants","unstable_createServerEntryAdapter","createServerEntryAdapter","unstable_honoMiddleware","honoMiddleware","DIST_PUBLIC","contextMiddleware","rscMiddleware","middlewareRunner","isWranglerDev","req","headers","get","removeGzipEncoding","res","contentType","includes","Headers","set","Response","body","status","statusText","processRequest","processBuild","config","notFoundHtml","options","middlewareFns","middlewareModules","app","notFound","c","html","text","use","middlewareFn","buildOptions","assetsDir","distDir","privateDir","rscBase","basePath","serverless","static","fetch","cloudflareContext","env","waitUntil","passThroughOnException","props","undefined","PROD","then","handlers","build","buildEnhancers"],"mappings":"AAAA,SAASA,IAAI,QAAQ,OAAO;AAE5B,SACEC,sBAAsBC,SAAS,EAC/BC,qCAAqCC,wBAAwB,EAC7DC,2BAA2BC,cAAc,QACpC,iBAAiB;AAGxB,MAAM,EAAEC,WAAW,EAAE,GAAGL;AACxB,MAAM,EAAEM,iBAAiB,EAAEC,aAAa,EAAEC,gBAAgB,EAAE,GAAGJ;AAE/D,SAASK,cAAcC,GAAY;IACjC,qEAAqE;IACrE,OAAO,CAACA,IAAIC,OAAO,CAACC,GAAG,CAAC;AAC1B;AAEA,SAASC,mBAAmBC,GAAa;IACvC,MAAMC,cAAcD,IAAIH,OAAO,CAACC,GAAG,CAAC;IACpC,IACE,CAACG,eACDA,YAAYC,QAAQ,CAAC,gBACrBD,YAAYC,QAAQ,CAAC,eACrB;QACA,MAAML,UAAU,IAAIM,QAAQH,IAAIH,OAAO;QACvCA,QAAQO,GAAG,CAAC,oBAAoB;QAChC,OAAO,IAAIC,SAASL,IAAIM,IAAI,EAAE;YAC5BC,QAAQP,IAAIO,MAAM;YAClBC,YAAYR,IAAIQ,UAAU;YAC1BX;QACF;IACF;IACA,OAAOG;AACT;AAEA,eAAeZ,yBACb,CACE,EAAEqB,cAAc,EAAEC,YAAY,EAAEC,MAAM,EAAEC,YAAY,EAAE,EACtDC;IAQA,MAAM,EAAEC,gBAAgB,EAAE,EAAEC,oBAAoB,CAAC,CAAC,EAAE,GAAGF,WAAW,CAAC;IACnE,MAAMG,MAAM,IAAIhC;IAChBgC,IAAIC,QAAQ,CAAC,CAACC;QACZ,IAAIN,cAAc;YAChB,OAAOM,EAAEC,IAAI,CAACP,cAAc;QAC9B;QACA,OAAOM,EAAEE,IAAI,CAAC,iBAAiB;IACjC;IACAJ,IAAIK,GAAG,CAAC7B;IACR,KAAK,MAAM8B,gBAAgBR,cAAe;QACxCE,IAAIK,GAAG,CAACC;IACV;IACAN,IAAIK,GAAG,CAAC3B,iBAAiBqB;IACzBC,IAAIK,GAAG,CAAC5B,cAAc;QAAEgB;IAAe;IACvC,MAAMc,eAA6B;QACjCC,WAAWX,SAASW,aAAa;QACjCC,SAASd,OAAOc,OAAO;QACvBC,YAAYf,OAAOe,UAAU;QAC7BC,SAAShB,OAAOgB,OAAO;QACvBC,UAAUjB,OAAOiB,QAAQ;QACzBrC;QACAsC,YAAY,CAAChB,SAASiB;IACxB;IAEA,OAAO;QACLC,OAAO,OAAOnC;YACZ,IAAIoC;YACJ,IAAI;gBACF,wEAAwE;gBACxE,gDAAgD;gBAChDA,oBAAoB,MAAM,MAAM,CAAC;YACnC,EAAE,OAAM;YACN,kCAAkC;YACpC;YACA,IAAIhC;YACJ,IAAIgC,mBAAmB;gBACrB,MAAM,EAAEC,GAAG,EAAEC,SAAS,EAAEC,sBAAsB,EAAE,GAAGH;gBACnDhC,MAAMgB,IAAIe,KAAK,CAACnC,KAAKqC,KAAK;oBACxBC;oBACAC;oBACAC,OAAOC;gBACT;YACF,OAAO;gBACLrC,MAAMgB,IAAIe,KAAK,CAACnC;YAClB;YACA,mEAAmE;YACnE,IAAI,YAAYqC,GAAG,EAAEK,QAAQ3C,cAAcC,MAAM;gBAC/C,IAAI,UAAUI,KAAK;oBACjBA,MAAMA,IAAIuC,IAAI,CAAC,CAACvC,MAAQD,mBAAmBC;gBAC7C,OAAO;oBACLA,MAAMD,mBAAmBC;gBAC3B;YACF;YACA,OAAOA;QACT;QACAwC,UAAU3B,SAAS2B;QACnBC,OAAO/B;QACPa;QACAmB,gBAAgB;YAAC;SAA0C;IAC7D;AACF,GACA"}