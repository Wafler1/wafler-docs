{"version":3,"sources":["../../src/adapters/cloudflare-build-enhancer.ts"],"sourcesContent":["import fs from 'node:fs';\nimport path from 'node:path';\n\nexport type BuildOptions = {\n  assetsDir: string;\n  distDir: string;\n  rscBase: string;\n  privateDir: string;\n  basePath: string;\n  DIST_PUBLIC: string;\n  serverless: boolean;\n};\n\nasync function postBuild({ distDir, DIST_PUBLIC, serverless }: BuildOptions) {\n  const mainEntry = path.resolve(\n    path.join(distDir, 'server', 'serve-cloudflare.js'),\n  );\n  fs.writeFileSync(\n    mainEntry,\n    `\\\nimport { INTERNAL_runFetch, unstable_serverEntry as serverEntry } from './index.js';\n\nexport default {\n  ...(serverEntry.handlers ? serverEntry.handlers : {}),\n  fetch: (request, env, ...args) => INTERNAL_runFetch(env, request, env, ...args),\n};\n`,\n  );\n\n  const wranglerTomlFile = path.resolve('wrangler.toml');\n  const wranglerJsonFile = path.resolve('wrangler.json');\n  const wranglerJsoncFile = path.resolve('wrangler.jsonc');\n  if (\n    !fs.existsSync(wranglerTomlFile) &&\n    !fs.existsSync(wranglerJsonFile) &&\n    !fs.existsSync(wranglerJsoncFile)\n  ) {\n    let projectName = 'waku-project';\n    try {\n      const packageJsonPath = path.resolve('package.json');\n      const packageJson = JSON.parse(fs.readFileSync(packageJsonPath, 'utf-8'));\n      if (packageJson.name && typeof packageJson.name === 'string') {\n        projectName = packageJson.name;\n      }\n    } catch {\n      // Fall back to default if package.json can't be read or parsed\n    }\n    fs.writeFileSync(\n      wranglerJsoncFile,\n      `\\\n{\n  \"$schema\": \"node_modules/wrangler/config-schema.json\",\n  \"name\": ${JSON.stringify(projectName)},\n  ${\n    serverless\n      ? `\"main\": ${JSON.stringify(forceRelativePath(path.relative(process.cwd(), mainEntry)))},\n  // nodejs_als is required for Waku server-side request context\n  // It can be removed if only building static pages\n  \"compatibility_flags\": [\"nodejs_als\"],\n  `\n      : ''\n  }// https://developers.cloudflare.com/workers/platform/compatibility-dates\n  \"compatibility_date\": \"2025-11-17\",\n  \"assets\": {\n    ${\n      serverless\n        ? `// https://developers.cloudflare.com/workers/static-assets/binding/\n    \"binding\": \"ASSETS\",\n    `\n        : ''\n    }\"directory\": \"./${distDir}/${DIST_PUBLIC}\",\n    \"html_handling\": \"drop-trailing-slash\"\n  },\n  \"rules\": [\n    {\n      \"type\": \"ESModule\",\n      \"globs\": [\"**/*.js\", \"**/*.mjs\"],\n    },\n  ],\n  \"no_bundle\": true,\n}\n`,\n    );\n  }\n}\n\nexport default async function buildEnhancer(\n  build: (utils: unknown, options: BuildOptions) => Promise<void>,\n): Promise<typeof build> {\n  return async (utils: unknown, options: BuildOptions) => {\n    await build(utils, options);\n    await postBuild(options);\n  };\n}\n\nconst forceRelativePath = (s: string) => (s.startsWith('.') ? s : './' + s);\n"],"names":["fs","path","postBuild","distDir","DIST_PUBLIC","serverless","mainEntry","resolve","join","writeFileSync","wranglerTomlFile","wranglerJsonFile","wranglerJsoncFile","existsSync","projectName","packageJsonPath","packageJson","JSON","parse","readFileSync","name","stringify","forceRelativePath","relative","process","cwd","buildEnhancer","build","utils","options","s","startsWith"],"mappings":"AAAA,OAAOA,QAAQ,UAAU;AACzB,OAAOC,UAAU,YAAY;AAY7B,eAAeC,UAAU,EAAEC,OAAO,EAAEC,WAAW,EAAEC,UAAU,EAAgB;IACzE,MAAMC,YAAYL,KAAKM,OAAO,CAC5BN,KAAKO,IAAI,CAACL,SAAS,UAAU;IAE/BH,GAAGS,aAAa,CACdH,WACA,CAAC;;;;;;;AAOL,CAAC;IAGC,MAAMI,mBAAmBT,KAAKM,OAAO,CAAC;IACtC,MAAMI,mBAAmBV,KAAKM,OAAO,CAAC;IACtC,MAAMK,oBAAoBX,KAAKM,OAAO,CAAC;IACvC,IACE,CAACP,GAAGa,UAAU,CAACH,qBACf,CAACV,GAAGa,UAAU,CAACF,qBACf,CAACX,GAAGa,UAAU,CAACD,oBACf;QACA,IAAIE,cAAc;QAClB,IAAI;YACF,MAAMC,kBAAkBd,KAAKM,OAAO,CAAC;YACrC,MAAMS,cAAcC,KAAKC,KAAK,CAAClB,GAAGmB,YAAY,CAACJ,iBAAiB;YAChE,IAAIC,YAAYI,IAAI,IAAI,OAAOJ,YAAYI,IAAI,KAAK,UAAU;gBAC5DN,cAAcE,YAAYI,IAAI;YAChC;QACF,EAAE,OAAM;QACN,+DAA+D;QACjE;QACApB,GAAGS,aAAa,CACdG,mBACA,CAAC;;;UAGG,EAAEK,KAAKI,SAAS,CAACP,aAAa;EACtC,EACET,aACI,CAAC,QAAQ,EAAEY,KAAKI,SAAS,CAACC,kBAAkBrB,KAAKsB,QAAQ,CAACC,QAAQC,GAAG,IAAInB,aAAa;;;;EAI5F,CAAC,GACK,GACL;;;IAGC,EACED,aACI,CAAC;;IAEP,CAAC,GACK,GACL,gBAAgB,EAAEF,QAAQ,CAAC,EAAEC,YAAY;;;;;;;;;;;AAW9C,CAAC;IAEC;AACF;AAEA,eAAe,eAAesB,cAC5BC,KAA+D;IAE/D,OAAO,OAAOC,OAAgBC;QAC5B,MAAMF,MAAMC,OAAOC;QACnB,MAAM3B,UAAU2B;IAClB;AACF;AAEA,MAAMP,oBAAoB,CAACQ,IAAeA,EAAEC,UAAU,CAAC,OAAOD,IAAI,OAAOA"}