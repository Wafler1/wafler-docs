{"version":3,"file":"build-mdx-CKIy8c5h.js","names":[],"sources":["../src/loaders/mdx/remark-postprocess.ts","../src/loaders/mdx/build-mdx.ts"],"sourcesContent":["import type { Processor, Transformer } from 'unified';\nimport type { Heading, Root, RootContent } from 'mdast';\nimport { visit } from 'unist-util-visit';\nimport { toMarkdown } from 'mdast-util-to-markdown';\nimport { valueToEstree } from 'estree-util-value-to-estree';\nimport { removePosition } from 'unist-util-remove-position';\nimport remarkMdx from 'remark-mdx';\nimport { flattenNode } from './mdast-utils';\n\nexport interface ExtractedReference {\n  href: string;\n}\n\nexport interface PostprocessOptions {\n  _format: 'md' | 'mdx';\n\n  /**\n   * Properties to export from `vfile.data`\n   */\n  valueToExport?: string[];\n\n  /**\n   * stringify MDAST and export via `_markdown`.\n   */\n  includeProcessedMarkdown?:\n    | boolean\n    | {\n        /**\n         * include heading IDs into the processed markdown.\n         */\n        headingIds?: boolean;\n      };\n\n  /**\n   * extract link references, export via `extractedReferences`.\n   */\n  extractLinkReferences?: boolean;\n\n  /**\n   * store MDAST and export via `_mdast`.\n   */\n  includeMDAST?:\n    | boolean\n    | {\n        removePosition?: boolean;\n      };\n}\n\n/**\n * - collect references\n * - write frontmatter (auto-title & description)\n */\nexport function remarkPostprocess(\n  this: Processor,\n  {\n    _format,\n    includeProcessedMarkdown = false,\n    includeMDAST = false,\n    extractLinkReferences = false,\n    valueToExport = [],\n  }: PostprocessOptions,\n): Transformer<Root, Root> {\n  let _stringifyProcessor: Processor | undefined;\n  const getStringifyProcessor = () => {\n    return (_stringifyProcessor ??=\n      _format === 'mdx'\n        ? this\n        : // force Markdown processor to stringify MDX nodes\n          this().use(remarkMdx).freeze());\n  };\n\n  return (tree, file) => {\n    const frontmatter = (file.data.frontmatter ??= {});\n    if (!frontmatter.title) {\n      visit(tree, 'heading', (node) => {\n        if (node.depth === 1) {\n          frontmatter.title = flattenNode(node);\n          return false;\n        }\n      });\n    }\n\n    file.data['mdx-export'] ??= [];\n    file.data['mdx-export'].push({\n      name: 'frontmatter',\n      value: frontmatter,\n    });\n\n    if (extractLinkReferences) {\n      const urls: ExtractedReference[] = [];\n\n      visit(tree, 'link', (node) => {\n        urls.push({\n          href: node.url,\n        });\n        return 'skip';\n      });\n\n      file.data['mdx-export'].push({\n        name: 'extractedReferences',\n        value: urls,\n      });\n    }\n\n    if (includeProcessedMarkdown) {\n      const { headingIds = true } =\n        typeof includeProcessedMarkdown === 'object' ? includeProcessedMarkdown : {};\n      const processor = getStringifyProcessor();\n      const markdown = toMarkdown(tree, {\n        ...processor.data('settings'),\n        // from https://github.com/remarkjs/remark/blob/main/packages/remark-stringify/lib/index.js\n        extensions: processor.data('toMarkdownExtensions') || [],\n        handlers: {\n          heading: (node: Heading) => {\n            const id = node.data?.hProperties?.id;\n            const content = flattenNode(node);\n            return headingIds && id ? `${content} [#${id}]` : content;\n          },\n        },\n      });\n\n      file.data['mdx-export'].push({\n        name: '_markdown',\n        value: markdown,\n      });\n    }\n\n    if (includeMDAST) {\n      const options = includeMDAST === true ? {} : includeMDAST;\n      const mdast = JSON.stringify(\n        options.removePosition ? removePosition(structuredClone(tree)) : tree,\n      );\n\n      file.data['mdx-export'].push({\n        name: '_mdast',\n        value: mdast,\n      });\n    }\n\n    for (const { name, value } of file.data['mdx-export']) {\n      tree.children.unshift(getMdastExport(name, value));\n    }\n\n    // reset the data to reduce memory usage\n    file.data['mdx-export'] = [];\n\n    for (const name of valueToExport) {\n      if (!(name in file.data)) continue;\n\n      tree.children.unshift(getMdastExport(name, file.data[name]));\n    }\n  };\n}\n\n/**\n * MDX.js first converts javascript (with esm support) into mdast nodes with remark-mdx, then handle the other remark plugins\n *\n * Therefore, if we want to inject an export, we must convert the object into AST, then add the mdast node\n */\nfunction getMdastExport(name: string, value: unknown): RootContent {\n  return {\n    type: 'mdxjsEsm',\n    value: '',\n    data: {\n      estree: {\n        type: 'Program',\n        sourceType: 'module',\n        body: [\n          {\n            type: 'ExportNamedDeclaration',\n            attributes: [],\n            specifiers: [],\n            source: null,\n            declaration: {\n              type: 'VariableDeclaration',\n              kind: 'let',\n              declarations: [\n                {\n                  type: 'VariableDeclarator',\n                  id: {\n                    type: 'Identifier',\n                    name,\n                  },\n                  init: valueToEstree(value),\n                },\n              ],\n            },\n          },\n        ],\n      },\n    },\n  };\n}\n","import { createProcessor } from '@mdx-js/mdx';\nimport { VFile } from 'vfile';\nimport { remarkInclude } from '@/loaders/mdx/remark-include';\nimport type { StructuredData } from 'fumadocs-core/mdx-plugins';\nimport type { TOCItemType } from 'fumadocs-core/toc';\nimport type { FC } from 'react';\nimport type { MDXProps } from 'mdx/types';\nimport { type PostprocessOptions, remarkPostprocess } from '@/loaders/mdx/remark-postprocess';\nimport type { Core } from '@/core';\nimport type { DocCollectionItem } from '@/config/build';\n\ntype Processor = ReturnType<typeof createProcessor>;\n\ninterface BuildMDXOptions {\n  /**\n   * Specify a file path for source\n   */\n  filePath: string;\n  source: string;\n  frontmatter?: Record<string, unknown>;\n\n  environment: 'bundler' | 'runtime';\n  isDevelopment: boolean;\n  _compiler?: CompilerOptions;\n}\n\nexport interface CompilerOptions {\n  addDependency: (file: string) => void;\n}\n\nexport interface CompiledMDXProperties<Frontmatter = Record<string, unknown>> {\n  frontmatter: Frontmatter;\n  structuredData: StructuredData;\n  toc: TOCItemType[];\n  default: FC<MDXProps>;\n\n  /**\n   * Enable from `postprocess` option.\n   */\n  _markdown?: string;\n  /**\n   * Enable from `postprocess` option.\n   */\n  _mdast?: string;\n}\n\nexport interface FumadocsDataMap {\n  /**\n   * [Fumadocs MDX] raw frontmatter, you can modify it\n   */\n  frontmatter?: Record<string, unknown>;\n\n  /**\n   * [Fumadocs MDX] additional ESM exports to write\n   */\n  'mdx-export'?: { name: string; value: unknown }[];\n\n  /**\n   * [Fumadocs MDX] The compiler object from loader\n   */\n  _compiler?: CompilerOptions;\n\n  /**\n   * [Fumadocs MDX] get internal processor, do not use this on user land.\n   */\n  _getProcessor?: (format: 'md' | 'mdx') => Processor;\n}\n\ndeclare module 'vfile' {\n  // eslint-disable-next-line @typescript-eslint/no-empty-object-type -- extend data map\n  interface DataMap extends FumadocsDataMap {}\n}\n\nexport async function buildMDX(\n  core: Core,\n  collection: DocCollectionItem | undefined,\n  { filePath, frontmatter, source, _compiler, environment, isDevelopment }: BuildMDXOptions,\n): Promise<VFile> {\n  const mdxOptions = await core.getConfig().getMDXOptions(collection, environment);\n\n  function getProcessor(format: 'md' | 'mdx') {\n    const cache = core.cache as Map<string, Processor>;\n    const key = `build-mdx:${collection?.name ?? 'global'}:${format}`;\n    let processor = cache.get(key);\n\n    if (!processor) {\n      const postprocessOptions: PostprocessOptions = {\n        _format: format,\n        ...collection?.postprocess,\n      };\n\n      processor = createProcessor({\n        outputFormat: 'program',\n        development: isDevelopment,\n        ...mdxOptions,\n        remarkPlugins: [\n          remarkInclude,\n          ...(mdxOptions.remarkPlugins ?? []),\n          [remarkPostprocess, postprocessOptions],\n        ],\n        format,\n      });\n\n      cache.set(key, processor);\n    }\n\n    return processor;\n  }\n\n  let vfile = new VFile({\n    value: source,\n    path: filePath,\n    cwd: collection?.cwd,\n    data: { frontmatter, _compiler, _getProcessor: getProcessor },\n  });\n\n  if (collection) {\n    vfile = await core.transformVFile({ collection, filePath, source }, vfile);\n  }\n\n  return getProcessor(filePath.endsWith('.mdx') ? 'mdx' : 'md').process(vfile);\n}\n"],"mappings":"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"}