{"version":3,"file":"json-schema.js","names":[],"sources":["../../src/plugins/json-schema.ts"],"sourcesContent":["import type { EmitEntry, Plugin } from '@/core';\nimport type { DocsCollectionItem, MetaCollectionItem } from '@/config/build';\nimport { z } from 'zod';\nimport fs from 'node:fs/promises';\nimport path from 'node:path';\n\nexport interface JSONSchemaOptions {\n  /**\n   * insert `$schema` field to JSON files on creation.\n   *\n   * @defaultValue false\n   */\n  insert?: boolean;\n}\n\n/**\n * Generate JSON schemas locally for collection schemas\n *\n * note: **it only works with Zod**\n */\nexport default function jsonSchema({ insert = false }: JSONSchemaOptions = {}): Plugin {\n  function getSchemaPath(name: string) {\n    return `json-schema/${name}.json`;\n  }\n\n  return {\n    configureServer(server) {\n      const { outDir } = this.core.getOptions();\n      if (!server.watcher || !insert) return;\n\n      server.watcher.on('add', async (file) => {\n        let parent: DocsCollectionItem | undefined;\n        let match: MetaCollectionItem | undefined;\n        for (const collection of this.core.getCollections()) {\n          if (collection.type === 'meta' && collection.hasFile(file)) {\n            match = collection;\n            break;\n          }\n          if (collection.type === 'docs' && collection.meta.hasFile(file)) {\n            parent = collection;\n            match = collection.meta;\n            break;\n          }\n        }\n\n        if (!match) return;\n        let obj: object;\n        try {\n          const content = (await fs.readFile(file)).toString();\n          obj = content.length > 0 ? JSON.parse(content) : {};\n        } catch {\n          return;\n        }\n\n        if ('$schema' in obj) return;\n        const schemaPath = path.join(\n          outDir,\n          getSchemaPath(parent ? `${parent.name}.meta` : match.name),\n        );\n        const updated = {\n          $schema: path.relative(path.dirname(file), schemaPath),\n          ...obj,\n        };\n\n        await fs.writeFile(file, JSON.stringify(updated, null, 2));\n      });\n    },\n    emit() {\n      const files: EmitEntry[] = [];\n\n      function onSchema(name: string, schema: z.ZodSchema) {\n        files.push({\n          path: getSchemaPath(name),\n          content: JSON.stringify(\n            z.toJSONSchema(schema, {\n              io: 'input',\n              unrepresentable: 'any',\n            }),\n          ),\n        });\n      }\n\n      for (const collection of this.core.getCollections()) {\n        if (collection.type === 'docs') {\n          if (collection.meta.schema instanceof z.ZodType) {\n            onSchema(`${collection.name}.meta`, collection.meta.schema);\n          }\n\n          if (collection.docs.schema instanceof z.ZodType) {\n            onSchema(`${collection.name}.docs`, collection.docs.schema);\n          }\n        } else if (collection.schema instanceof z.ZodType) {\n          onSchema(collection.name, collection.schema);\n        }\n      }\n\n      return files;\n    },\n  };\n}\n"],"mappings":";;;;;;;;;;AAoBA,SAAwB,WAAW,EAAE,SAAS,UAA6B,EAAE,EAAU;CACrF,SAAS,cAAc,MAAc;AACnC,SAAO,eAAe,KAAK;;AAG7B,QAAO;EACL,gBAAgB,QAAQ;GACtB,MAAM,EAAE,WAAW,KAAK,KAAK,YAAY;AACzC,OAAI,CAAC,OAAO,WAAW,CAAC,OAAQ;AAEhC,UAAO,QAAQ,GAAG,OAAO,OAAO,SAAS;IACvC,IAAI;IACJ,IAAI;AACJ,SAAK,MAAM,cAAc,KAAK,KAAK,gBAAgB,EAAE;AACnD,SAAI,WAAW,SAAS,UAAU,WAAW,QAAQ,KAAK,EAAE;AAC1D,cAAQ;AACR;;AAEF,SAAI,WAAW,SAAS,UAAU,WAAW,KAAK,QAAQ,KAAK,EAAE;AAC/D,eAAS;AACT,cAAQ,WAAW;AACnB;;;AAIJ,QAAI,CAAC,MAAO;IACZ,IAAI;AACJ,QAAI;KACF,MAAM,WAAW,MAAM,GAAG,SAAS,KAAK,EAAE,UAAU;AACpD,WAAM,QAAQ,SAAS,IAAI,KAAK,MAAM,QAAQ,GAAG,EAAE;YAC7C;AACN;;AAGF,QAAI,aAAa,IAAK;IACtB,MAAM,aAAa,KAAK,KACtB,QACA,cAAc,SAAS,GAAG,OAAO,KAAK,SAAS,MAAM,KAAK,CAC3D;IACD,MAAM,UAAU;KACd,SAAS,KAAK,SAAS,KAAK,QAAQ,KAAK,EAAE,WAAW;KACtD,GAAG;KACJ;AAED,UAAM,GAAG,UAAU,MAAM,KAAK,UAAU,SAAS,MAAM,EAAE,CAAC;KAC1D;;EAEJ,OAAO;GACL,MAAM,QAAqB,EAAE;GAE7B,SAAS,SAAS,MAAc,QAAqB;AACnD,UAAM,KAAK;KACT,MAAM,cAAc,KAAK;KACzB,SAAS,KAAK,UACZ,EAAE,aAAa,QAAQ;MACrB,IAAI;MACJ,iBAAiB;MAClB,CAAC,CACH;KACF,CAAC;;AAGJ,QAAK,MAAM,cAAc,KAAK,KAAK,gBAAgB,CACjD,KAAI,WAAW,SAAS,QAAQ;AAC9B,QAAI,WAAW,KAAK,kBAAkB,EAAE,QACtC,UAAS,GAAG,WAAW,KAAK,QAAQ,WAAW,KAAK,OAAO;AAG7D,QAAI,WAAW,KAAK,kBAAkB,EAAE,QACtC,UAAS,GAAG,WAAW,KAAK,QAAQ,WAAW,KAAK,OAAO;cAEpD,WAAW,kBAAkB,EAAE,QACxC,UAAS,WAAW,MAAM,WAAW,OAAO;AAIhD,UAAO;;EAEV"}