{"version":3,"file":"last-modified.js","names":[],"sources":["../../src/plugins/last-modified.ts"],"sourcesContent":["import path from 'node:path';\nimport { x } from 'tinyexec';\nimport type { Plugin } from '@/core';\nimport { ident } from '@/utils/codegen';\n\nconst cache = new Map<string, Promise<Date | null>>();\ntype VersionControlFn = (filePath: string) => Promise<Date | null | undefined>;\n\nexport interface LastModifiedPluginOptions {\n  /**\n   * Version control to obtain the last modified time.\n   *\n   * - `git`: Requires `git` to be installed.\n   *\n   *    If you are using Vercel, please set `VERCEL_DEEP_CLONE` environment variable to `true`.\n   *\n   * - A function: return the last modified time for given file path.\n   *\n   * @defaultValue 'git'\n   */\n  versionControl?: 'git' | VersionControlFn;\n\n  /**\n   * Filter the collections to include by names\n   */\n  filter?: (collection: string) => boolean;\n}\n\nconst ExtendTypes = `{\n  /**\n   * Last modified date of document file, obtained from version control.\n   *\n   */\n  lastModified?: Date;\n}`;\n\n/**\n * Injects `lastModified` property to page exports.\n */\nexport default function lastModified(options: LastModifiedPluginOptions = {}): Plugin {\n  const { versionControl = 'git', filter = () => true } = options;\n  let fn: VersionControlFn;\n\n  return {\n    name: 'last-modified',\n    'index-file': {\n      generateTypeConfig() {\n        const lines: string[] = [];\n        lines.push('{');\n        lines.push('  DocData: {');\n        for (const collection of this.core.getCollections()) {\n          if (filter(collection.name)) {\n            lines.push(ident(`${collection.name}: ${ExtendTypes},`, 2));\n          }\n        }\n        lines.push('  }');\n        lines.push('}');\n        return lines.join('\\n');\n      },\n      serverOptions(options) {\n        options.doc ??= {};\n        options.doc.passthroughs ??= [];\n        options.doc.passthroughs.push('lastModified');\n      },\n    },\n    config() {\n      const { workspace } = this.core.getOptions();\n      const cwd = workspace ? path.resolve(workspace.dir) : process.cwd();\n\n      switch (versionControl) {\n        case 'git':\n          fn = (v) => getGitTimestamp(v, cwd);\n          break;\n        default:\n          fn = versionControl;\n      }\n    },\n    doc: {\n      async vfile(file) {\n        if (!filter(this.collection.name)) return;\n\n        const timestamp = await fn(this.filePath);\n        if (timestamp) {\n          file.data['mdx-export'] ??= [];\n          file.data['mdx-export'].push({\n            name: 'lastModified',\n            value: timestamp,\n          });\n        }\n      },\n    },\n  };\n}\n\nasync function getGitTimestamp(file: string, cwd: string): Promise<Date | null> {\n  const cached = cache.get(file);\n  if (cached) return cached;\n\n  const timePromise = (async () => {\n    const out = await x('git', ['log', '-1', '--pretty=\"%ai\"', path.relative(cwd, file)], {\n      nodeOptions: {\n        cwd,\n      },\n    });\n\n    if (out.exitCode !== 0) return null;\n    const date = new Date(out.stdout);\n    return isNaN(date.getTime()) ? null : date;\n  })();\n\n  cache.set(file, timePromise);\n  return timePromise;\n}\n"],"mappings":";;;;;AAKA,MAAM,wBAAQ,IAAI,KAAmC;AAuBrD,MAAM,cAAc;;;;;;;;;;AAWpB,SAAwB,aAAa,UAAqC,EAAE,EAAU;CACpF,MAAM,EAAE,iBAAiB,OAAO,eAAe,SAAS;CACxD,IAAI;AAEJ,QAAO;EACL,MAAM;EACN,cAAc;GACZ,qBAAqB;IACnB,MAAM,QAAkB,EAAE;AAC1B,UAAM,KAAK,IAAI;AACf,UAAM,KAAK,eAAe;AAC1B,SAAK,MAAM,cAAc,KAAK,KAAK,gBAAgB,CACjD,KAAI,OAAO,WAAW,KAAK,CACzB,OAAM,KAAK,MAAM,GAAG,WAAW,KAAK,IAAI,YAAY,IAAI,EAAE,CAAC;AAG/D,UAAM,KAAK,MAAM;AACjB,UAAM,KAAK,IAAI;AACf,WAAO,MAAM,KAAK,KAAK;;GAEzB,cAAc,SAAS;AACrB,YAAQ,QAAQ,EAAE;AAClB,YAAQ,IAAI,iBAAiB,EAAE;AAC/B,YAAQ,IAAI,aAAa,KAAK,eAAe;;GAEhD;EACD,SAAS;GACP,MAAM,EAAE,cAAc,KAAK,KAAK,YAAY;GAC5C,MAAM,MAAM,YAAY,KAAK,QAAQ,UAAU,IAAI,GAAG,QAAQ,KAAK;AAEnE,WAAQ,gBAAR;IACE,KAAK;AACH,WAAM,MAAM,gBAAgB,GAAG,IAAI;AACnC;IACF,QACE,MAAK;;;EAGX,KAAK,EACH,MAAM,MAAM,MAAM;AAChB,OAAI,CAAC,OAAO,KAAK,WAAW,KAAK,CAAE;GAEnC,MAAM,YAAY,MAAM,GAAG,KAAK,SAAS;AACzC,OAAI,WAAW;AACb,SAAK,KAAK,kBAAkB,EAAE;AAC9B,SAAK,KAAK,cAAc,KAAK;KAC3B,MAAM;KACN,OAAO;KACR,CAAC;;KAGP;EACF;;AAGH,eAAe,gBAAgB,MAAc,KAAmC;CAC9E,MAAM,SAAS,MAAM,IAAI,KAAK;AAC9B,KAAI,OAAQ,QAAO;CAEnB,MAAM,eAAe,YAAY;EAC/B,MAAM,MAAM,MAAM,EAAE,OAAO;GAAC;GAAO;GAAM;GAAkB,KAAK,SAAS,KAAK,KAAK;GAAC,EAAE,EACpF,aAAa,EACX,KACD,EACF,CAAC;AAEF,MAAI,IAAI,aAAa,EAAG,QAAO;EAC/B,MAAM,OAAO,IAAI,KAAK,IAAI,OAAO;AACjC,SAAO,MAAM,KAAK,SAAS,CAAC,GAAG,OAAO;KACpC;AAEJ,OAAM,IAAI,MAAM,YAAY;AAC5B,QAAO"}