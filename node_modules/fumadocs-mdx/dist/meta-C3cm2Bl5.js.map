{"version":3,"file":"meta-C3cm2Bl5.js","names":[],"sources":["../src/loaders/meta.ts"],"sourcesContent":["import type { Loader, LoaderInput } from '@/loaders/adapter';\nimport type { ConfigLoader } from '@/loaders/config';\nimport { load } from 'js-yaml';\nimport { z } from 'zod';\nimport { metaLoaderGlob } from '.';\nimport type { MetaCollectionItem } from '@/config/build';\n\nconst querySchema = z.looseObject({\n  collection: z.string().optional(),\n  workspace: z.string().optional(),\n});\n\n/**\n * load meta files, fallback to bundler's built-in plugins when ?collection is unspecified.\n */\nexport function createMetaLoader(\n  { getCore }: ConfigLoader,\n  resolve: {\n    json?: 'json' | 'js';\n    yaml?: 'js';\n  } = {},\n): Loader {\n  const { json: resolveJson = 'js' } = resolve;\n\n  function parse(filePath: string, source: string) {\n    try {\n      if (filePath.endsWith('.json')) return JSON.parse(source);\n      if (filePath.endsWith('.yaml')) return load(source);\n    } catch (e) {\n      throw new Error(`invalid data in ${filePath}`, { cause: e });\n    }\n\n    throw new Error('Unknown file type ' + filePath);\n  }\n\n  function onMeta(source: string, { filePath, query }: LoaderInput) {\n    const parsed = querySchema.safeParse(query);\n    if (!parsed.success || !parsed.data.collection) return null;\n    const { collection: collectionName, workspace } = parsed.data;\n\n    return async (): Promise<unknown> => {\n      let core = await getCore();\n      if (workspace) {\n        core = core.getWorkspaces().get(workspace) ?? core;\n      }\n\n      const collection = core.getCollection(collectionName);\n      let metaCollection: MetaCollectionItem | undefined;\n\n      switch (collection?.type) {\n        case 'meta':\n          metaCollection = collection;\n          break;\n        case 'docs':\n          metaCollection = collection.meta;\n          break;\n      }\n\n      const data = parse(filePath, source);\n\n      if (!metaCollection) return data;\n      return core.transformMeta(\n        {\n          collection: metaCollection,\n          filePath,\n          source,\n        },\n        data,\n      );\n    };\n  }\n\n  return {\n    test: metaLoaderGlob,\n    async load(input) {\n      const result = onMeta(await input.getSource(), input);\n      if (result === null) return null;\n      const data = await result();\n\n      if (input.filePath.endsWith('.json')) {\n        return {\n          moduleType: resolveJson,\n          code:\n            resolveJson === 'json'\n              ? JSON.stringify(data)\n              : `export default ${JSON.stringify(data)}`,\n        };\n      } else {\n        return {\n          moduleType: 'js',\n          code: `export default ${JSON.stringify(data)}`,\n        };\n      }\n    },\n    bun: {\n      load(source, input) {\n        const result = onMeta(source, input);\n        if (result === null)\n          return {\n            loader: 'object',\n            exports: parse(input.filePath, source),\n          };\n\n        return result().then((data) => ({\n          loader: 'object',\n          exports: { default: data },\n        }));\n      },\n    },\n  };\n}\n"],"mappings":";;;;;AAOA,MAAM,cAAc,EAAE,YAAY;CAChC,YAAY,EAAE,QAAQ,CAAC,UAAU;CACjC,WAAW,EAAE,QAAQ,CAAC,UAAU;CACjC,CAAC;;;;AAKF,SAAgB,iBACd,EAAE,WACF,UAGI,EAAE,EACE;CACR,MAAM,EAAE,MAAM,cAAc,SAAS;CAErC,SAAS,MAAM,UAAkB,QAAgB;AAC/C,MAAI;AACF,OAAI,SAAS,SAAS,QAAQ,CAAE,QAAO,KAAK,MAAM,OAAO;AACzD,OAAI,SAAS,SAAS,QAAQ,CAAE,QAAO,KAAK,OAAO;WAC5C,GAAG;AACV,SAAM,IAAI,MAAM,mBAAmB,YAAY,EAAE,OAAO,GAAG,CAAC;;AAG9D,QAAM,IAAI,MAAM,uBAAuB,SAAS;;CAGlD,SAAS,OAAO,QAAgB,EAAE,UAAU,SAAsB;EAChE,MAAM,SAAS,YAAY,UAAU,MAAM;AAC3C,MAAI,CAAC,OAAO,WAAW,CAAC,OAAO,KAAK,WAAY,QAAO;EACvD,MAAM,EAAE,YAAY,gBAAgB,cAAc,OAAO;AAEzD,SAAO,YAA8B;GACnC,IAAI,OAAO,MAAM,SAAS;AAC1B,OAAI,UACF,QAAO,KAAK,eAAe,CAAC,IAAI,UAAU,IAAI;GAGhD,MAAM,aAAa,KAAK,cAAc,eAAe;GACrD,IAAI;AAEJ,WAAQ,YAAY,MAApB;IACE,KAAK;AACH,sBAAiB;AACjB;IACF,KAAK;AACH,sBAAiB,WAAW;AAC5B;;GAGJ,MAAM,OAAO,MAAM,UAAU,OAAO;AAEpC,OAAI,CAAC,eAAgB,QAAO;AAC5B,UAAO,KAAK,cACV;IACE,YAAY;IACZ;IACA;IACD,EACD,KACD;;;AAIL,QAAO;EACL,MAAM;EACN,MAAM,KAAK,OAAO;GAChB,MAAM,SAAS,OAAO,MAAM,MAAM,WAAW,EAAE,MAAM;AACrD,OAAI,WAAW,KAAM,QAAO;GAC5B,MAAM,OAAO,MAAM,QAAQ;AAE3B,OAAI,MAAM,SAAS,SAAS,QAAQ,CAClC,QAAO;IACL,YAAY;IACZ,MACE,gBAAgB,SACZ,KAAK,UAAU,KAAK,GACpB,kBAAkB,KAAK,UAAU,KAAK;IAC7C;OAED,QAAO;IACL,YAAY;IACZ,MAAM,kBAAkB,KAAK,UAAU,KAAK;IAC7C;;EAGL,KAAK,EACH,KAAK,QAAQ,OAAO;GAClB,MAAM,SAAS,OAAO,QAAQ,MAAM;AACpC,OAAI,WAAW,KACb,QAAO;IACL,QAAQ;IACR,SAAS,MAAM,MAAM,UAAU,OAAO;IACvC;AAEH,UAAO,QAAQ,CAAC,MAAM,UAAU;IAC9B,QAAQ;IACR,SAAS,EAAE,SAAS,MAAM;IAC3B,EAAE;KAEN;EACF"}