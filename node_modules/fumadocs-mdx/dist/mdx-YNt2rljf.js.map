{"version":3,"file":"mdx-YNt2rljf.js","names":[],"sources":["../src/loaders/mdx/index.ts"],"sourcesContent":["import { fumaMatter } from '@/utils/fuma-matter';\nimport type { Loader } from '@/loaders/adapter';\nimport { z } from 'zod';\nimport type { DocCollectionItem } from '@/config/build';\nimport fs from 'node:fs/promises';\nimport path from 'node:path';\nimport { createHash } from 'node:crypto';\nimport type { ConfigLoader } from '@/loaders/config';\nimport { mdxLoaderGlob } from '..';\n\nconst querySchema = z.looseObject({\n  only: z.literal(['frontmatter', 'all']).default('all'),\n  collection: z.string().optional(),\n  workspace: z.string().optional(),\n});\n\nconst cacheEntry = z.object({\n  code: z.string(),\n  map: z.any().optional(),\n  hash: z.string().optional(),\n});\n\ntype CacheEntry = z.infer<typeof cacheEntry>;\n\nexport function createMdxLoader({ getCore }: ConfigLoader): Loader {\n  return {\n    test: mdxLoaderGlob,\n    async load({ getSource, development: isDevelopment, query, compiler, filePath }) {\n      let core = await getCore();\n      const value = await getSource();\n      const matter = fumaMatter(value);\n      const { collection: collectionName, workspace, only } = querySchema.parse(query);\n      if (workspace) {\n        core = core.getWorkspaces().get(workspace) ?? core;\n      }\n\n      let after: (() => Promise<void>) | undefined;\n\n      const { experimentalBuildCache = false } = core.getConfig().global;\n      if (!isDevelopment && experimentalBuildCache) {\n        const cacheDir = experimentalBuildCache;\n        const cacheKey = `${collectionName ?? 'global'}_${generateCacheHash(filePath)}`;\n\n        const cached = await fs\n          .readFile(path.join(cacheDir, cacheKey))\n          .then((content) => cacheEntry.parse(JSON.parse(content.toString())))\n          .catch(() => null);\n\n        if (cached && cached.hash === generateCacheHash(value)) return cached;\n        after = async () => {\n          await fs.mkdir(cacheDir, { recursive: true });\n          await fs.writeFile(\n            path.join(cacheDir, cacheKey),\n            JSON.stringify({\n              ...out,\n              hash: generateCacheHash(value),\n            } satisfies CacheEntry),\n          );\n        };\n      }\n\n      const collection = collectionName ? core.getCollection(collectionName) : undefined;\n\n      let docCollection: DocCollectionItem | undefined;\n      switch (collection?.type) {\n        case 'doc':\n          docCollection = collection;\n          break;\n        case 'docs':\n          docCollection = collection.docs;\n          break;\n      }\n\n      if (docCollection) {\n        matter.data = await core.transformFrontmatter(\n          { collection: docCollection, filePath, source: value },\n          matter.data as Record<string, unknown>,\n        );\n      }\n\n      if (only === 'frontmatter') {\n        return {\n          code: `export const frontmatter = ${JSON.stringify(matter.data)}`,\n          map: null,\n        };\n      }\n\n      const { buildMDX } = await import('@/loaders/mdx/build-mdx');\n      const compiled = await buildMDX(core, docCollection, {\n        isDevelopment,\n        // ensure the line number is correct in errors\n        source: '\\n'.repeat(countLines(matter.matter)) + matter.content,\n        filePath,\n        frontmatter: matter.data as Record<string, unknown>,\n        _compiler: compiler,\n        environment: 'bundler',\n      });\n\n      const out = {\n        code: String(compiled.value),\n        map: compiled.map,\n      };\n\n      await after?.();\n      return out;\n    },\n  };\n}\n\nfunction generateCacheHash(input: string): string {\n  return createHash('md5').update(input).digest('hex');\n}\n\nfunction countLines(s: string) {\n  let num = 0;\n\n  for (const c of s) {\n    if (c === '\\n') num++;\n  }\n\n  return num;\n}\n"],"mappings":";;;;;;;;AAUA,MAAM,cAAc,EAAE,YAAY;CAChC,MAAM,EAAE,QAAQ,CAAC,eAAe,MAAM,CAAC,CAAC,QAAQ,MAAM;CACtD,YAAY,EAAE,QAAQ,CAAC,UAAU;CACjC,WAAW,EAAE,QAAQ,CAAC,UAAU;CACjC,CAAC;AAEF,MAAM,aAAa,EAAE,OAAO;CAC1B,MAAM,EAAE,QAAQ;CAChB,KAAK,EAAE,KAAK,CAAC,UAAU;CACvB,MAAM,EAAE,QAAQ,CAAC,UAAU;CAC5B,CAAC;AAIF,SAAgB,gBAAgB,EAAE,WAAiC;AACjE,QAAO;EACL,MAAM;EACN,MAAM,KAAK,EAAE,WAAW,aAAa,eAAe,OAAO,UAAU,YAAY;GAC/E,IAAI,OAAO,MAAM,SAAS;GAC1B,MAAM,QAAQ,MAAM,WAAW;GAC/B,MAAM,SAAS,WAAW,MAAM;GAChC,MAAM,EAAE,YAAY,gBAAgB,WAAW,SAAS,YAAY,MAAM,MAAM;AAChF,OAAI,UACF,QAAO,KAAK,eAAe,CAAC,IAAI,UAAU,IAAI;GAGhD,IAAI;GAEJ,MAAM,EAAE,yBAAyB,UAAU,KAAK,WAAW,CAAC;AAC5D,OAAI,CAAC,iBAAiB,wBAAwB;IAC5C,MAAM,WAAW;IACjB,MAAM,WAAW,GAAG,kBAAkB,SAAS,GAAG,kBAAkB,SAAS;IAE7E,MAAM,SAAS,MAAM,GAClB,SAAS,KAAK,KAAK,UAAU,SAAS,CAAC,CACvC,MAAM,YAAY,WAAW,MAAM,KAAK,MAAM,QAAQ,UAAU,CAAC,CAAC,CAAC,CACnE,YAAY,KAAK;AAEpB,QAAI,UAAU,OAAO,SAAS,kBAAkB,MAAM,CAAE,QAAO;AAC/D,YAAQ,YAAY;AAClB,WAAM,GAAG,MAAM,UAAU,EAAE,WAAW,MAAM,CAAC;AAC7C,WAAM,GAAG,UACP,KAAK,KAAK,UAAU,SAAS,EAC7B,KAAK,UAAU;MACb,GAAG;MACH,MAAM,kBAAkB,MAAM;MAC/B,CAAsB,CACxB;;;GAIL,MAAM,aAAa,iBAAiB,KAAK,cAAc,eAAe,GAAG;GAEzE,IAAI;AACJ,WAAQ,YAAY,MAApB;IACE,KAAK;AACH,qBAAgB;AAChB;IACF,KAAK;AACH,qBAAgB,WAAW;AAC3B;;AAGJ,OAAI,cACF,QAAO,OAAO,MAAM,KAAK,qBACvB;IAAE,YAAY;IAAe;IAAU,QAAQ;IAAO,EACtD,OAAO,KACR;AAGH,OAAI,SAAS,cACX,QAAO;IACL,MAAM,8BAA8B,KAAK,UAAU,OAAO,KAAK;IAC/D,KAAK;IACN;GAGH,MAAM,EAAE,aAAa,MAAM,OAAO;GAClC,MAAM,WAAW,MAAM,SAAS,MAAM,eAAe;IACnD;IAEA,QAAQ,KAAK,OAAO,WAAW,OAAO,OAAO,CAAC,GAAG,OAAO;IACxD;IACA,aAAa,OAAO;IACpB,WAAW;IACX,aAAa;IACd,CAAC;GAEF,MAAM,MAAM;IACV,MAAM,OAAO,SAAS,MAAM;IAC5B,KAAK,SAAS;IACf;AAED,SAAM,SAAS;AACf,UAAO;;EAEV;;AAGH,SAAS,kBAAkB,OAAuB;AAChD,QAAO,WAAW,MAAM,CAAC,OAAO,MAAM,CAAC,OAAO,MAAM;;AAGtD,SAAS,WAAW,GAAW;CAC7B,IAAI,MAAM;AAEV,MAAK,MAAM,KAAK,EACd,KAAI,MAAM,KAAM;AAGlB,QAAO"}