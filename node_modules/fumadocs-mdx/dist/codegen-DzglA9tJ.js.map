{"version":3,"file":"codegen-DzglA9tJ.js","names":[],"sources":["../src/utils/codegen.ts"],"sourcesContent":["import path from 'node:path';\nimport { glob } from 'tinyglobby';\n\nexport interface GlobImportOptions {\n  base: string;\n  query?: Record<string, string | undefined>;\n  import?: string;\n  eager?: boolean;\n}\n\nexport interface CodeGenOptions {\n  target: 'default' | 'vite';\n  outDir: string;\n  /**\n   * add .js extenstion to imports\n   */\n  jsExtension: boolean;\n  globCache: Map<string, Promise<string[]>>;\n}\n\nexport type CodeGen = ReturnType<typeof createCodegen>;\n\n/**\n * Code generator (one instance per file)\n */\nexport function createCodegen({\n  target = 'default',\n  outDir = '',\n  jsExtension = false,\n  globCache = new Map(),\n}: Partial<CodeGenOptions>) {\n  let eagerImportId = 0;\n  const banner: string[] = ['// @ts-nocheck'];\n\n  if (target === 'vite') {\n    banner.push('/// <reference types=\"vite/client\" />');\n  }\n\n  return {\n    options: {\n      target,\n      outDir,\n    } as CodeGenOptions,\n    lines: [] as string[],\n    addImport(statement: string) {\n      this.lines.unshift(statement);\n    },\n    async pushAsync(insert: Promise<string | undefined>[]) {\n      for (const line of await Promise.all(insert)) {\n        if (line === undefined) continue;\n\n        this.lines.push(line);\n      }\n    },\n\n    async generateGlobImport(\n      patterns: string | string[],\n      options: GlobImportOptions,\n    ): Promise<string> {\n      if (target === 'vite') {\n        return this.generateViteGlobImport(patterns, options);\n      }\n\n      return this.generateNodeGlobImport(patterns, options);\n    },\n\n    generateViteGlobImport(\n      patterns: string | string[],\n      { base, ...rest }: GlobImportOptions,\n    ): string {\n      patterns = (typeof patterns === 'string' ? [patterns] : patterns).map(normalizeViteGlobPath);\n\n      return `import.meta.glob(${JSON.stringify(patterns)}, ${JSON.stringify(\n        {\n          base: normalizeViteGlobPath(path.relative(outDir, base)),\n          ...rest,\n        },\n        null,\n        2,\n      )})`;\n    },\n    async generateNodeGlobImport(\n      patterns: string | string[],\n      { base, eager = false, query = {}, import: importName }: GlobImportOptions,\n    ): Promise<string> {\n      const cacheKey = JSON.stringify({ patterns, base });\n      let files = globCache.get(cacheKey);\n      if (!files) {\n        files = glob(patterns, {\n          cwd: base,\n        });\n        globCache.set(cacheKey, files);\n      }\n\n      let code: string = '{';\n      for (const item of await files) {\n        const fullPath = path.join(base, item);\n        const searchParams = new URLSearchParams();\n\n        for (const [k, v] of Object.entries(query)) {\n          if (v !== undefined) searchParams.set(k, v);\n        }\n\n        const importPath = this.formatImportPath(fullPath) + '?' + searchParams.toString();\n        if (eager) {\n          const name = `__fd_glob_${eagerImportId++}`;\n          this.lines.unshift(\n            importName\n              ? `import { ${importName} as ${name} } from ${JSON.stringify(importPath)}`\n              : `import * as ${name} from ${JSON.stringify(importPath)}`,\n          );\n\n          code += `${JSON.stringify(item)}: ${name}, `;\n        } else {\n          let line = `${JSON.stringify(item)}: () => import(${JSON.stringify(importPath)})`;\n          if (importName) {\n            line += `.then(mod => mod.${importName})`;\n          }\n\n          code += `${line}, `;\n        }\n      }\n\n      code += '}';\n      return code;\n    },\n    formatImportPath(file: string) {\n      const ext = path.extname(file);\n      let filename: string;\n\n      if (ext === '.ts') {\n        filename = file.substring(0, file.length - ext.length);\n        if (jsExtension) filename += '.js';\n      } else {\n        filename = file;\n      }\n\n      const importPath = slash(path.relative(outDir, filename));\n      return importPath.startsWith('.') ? importPath : `./${importPath}`;\n    },\n    toString() {\n      return [...banner, ...this.lines].join('\\n');\n    },\n  };\n}\n\n/**\n * convert into POSIX & relative file paths, such that Vite can accept it.\n */\nfunction normalizeViteGlobPath(file: string) {\n  file = slash(file);\n  if (file.startsWith('./')) return file;\n  if (file.startsWith('/')) return `.${file}`;\n\n  return `./${file}`;\n}\n\nexport function slash(path: string): string {\n  const isExtendedLengthPath = path.startsWith('\\\\\\\\?\\\\');\n\n  if (isExtendedLengthPath) {\n    return path;\n  }\n\n  return path.replaceAll('\\\\', '/');\n}\n\nexport function ident(code: string, tab: number = 1) {\n  return code\n    .split('\\n')\n    .map((v) => '  '.repeat(tab) + v)\n    .join('\\n');\n}\n"],"mappings":"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"}