{"version":3,"file":"dynamic.js","names":[],"sources":["../../src/runtime/dynamic.ts"],"sourcesContent":["import { buildConfig, type DocCollectionItem } from '@/config/build';\nimport { buildMDX, type CompiledMDXProperties } from '@/loaders/mdx/build-mdx';\nimport { executeMdx } from '@fumadocs/mdx-remote/client';\nimport { pathToFileURL } from 'node:url';\nimport { fumaMatter } from '@/utils/fuma-matter';\nimport fs from 'node:fs/promises';\nimport { server, type ServerOptions } from './server';\nimport { type CoreOptions, createCore } from '@/core';\nimport type { FileInfo, InternalTypeConfig } from './types';\n\nexport interface LazyEntry<Data = unknown> {\n  info: FileInfo;\n  data: Data;\n\n  hash?: string;\n}\n\nexport type CreateDynamic<Config, TC extends InternalTypeConfig = InternalTypeConfig> = ReturnType<\n  typeof dynamic<Config, TC>\n>;\n\nexport async function dynamic<Config, TC extends InternalTypeConfig>(\n  configExports: Config,\n  coreOptions: CoreOptions,\n  serverOptions?: ServerOptions,\n) {\n  const core = createCore(coreOptions);\n  await core.init({\n    config: buildConfig(configExports as Record<string, unknown>),\n  });\n\n  const create = server<Config, TC>(serverOptions);\n\n  function getDocCollection(name: string): DocCollectionItem | undefined {\n    const collection = core.getCollection(name);\n    if (!collection) return;\n\n    if (collection.type === 'docs') return collection.docs;\n    else if (collection.type === 'doc') return collection;\n  }\n\n  function convertLazyEntries(collection: DocCollectionItem, entries: LazyEntry[]) {\n    const head: Record<string, () => unknown> = {};\n    const body: Record<string, () => Promise<unknown>> = {};\n\n    async function compile({ info, data }: LazyEntry<unknown>) {\n      let content = (await fs.readFile(info.fullPath)).toString();\n      content = fumaMatter(content).content;\n\n      const compiled = await buildMDX(core, collection, {\n        filePath: info.fullPath,\n        source: content,\n        frontmatter: data as Record<string, unknown>,\n        isDevelopment: false,\n        environment: 'runtime',\n      });\n\n      return (await executeMdx(String(compiled.value), {\n        baseUrl: pathToFileURL(info.fullPath),\n      })) as CompiledMDXProperties;\n    }\n\n    for (const entry of entries) {\n      head[entry.info.path] = () => entry.data;\n      let cachedResult: Promise<CompiledMDXProperties> | undefined;\n      body[entry.info.path] = () => (cachedResult ??= compile(entry));\n    }\n\n    return { head, body };\n  }\n\n  return {\n    async doc<Name extends keyof Config & string>(\n      name: Name,\n      base: string,\n      entries: LazyEntry<unknown>[],\n    ) {\n      const collection = getDocCollection(name as string);\n      if (!collection) throw new Error(`the doc collection ${name as string} doesn't exist.`);\n\n      const { head, body } = convertLazyEntries(collection, entries);\n\n      return create.docLazy(name, base, head, body);\n    },\n    async docs<Name extends keyof Config & string>(\n      name: Name,\n      base: string,\n      meta: Record<string, unknown>,\n      entries: LazyEntry<unknown>[],\n    ) {\n      const collection = getDocCollection(name as string);\n      if (!collection) throw new Error(`the doc collection ${name as string} doesn't exist.`);\n\n      const docs = convertLazyEntries(collection, entries);\n      return create.docsLazy(name, base, meta, docs.head, docs.body);\n    },\n  };\n}\n"],"mappings":";;;;;;;;;;;;;AAqBA,eAAsB,QACpB,eACA,aACA,eACA;CACA,MAAM,OAAO,WAAW,YAAY;AACpC,OAAM,KAAK,KAAK,EACd,QAAQ,YAAY,cAAyC,EAC9D,CAAC;CAEF,MAAM,SAAS,OAAmB,cAAc;CAEhD,SAAS,iBAAiB,MAA6C;EACrE,MAAM,aAAa,KAAK,cAAc,KAAK;AAC3C,MAAI,CAAC,WAAY;AAEjB,MAAI,WAAW,SAAS,OAAQ,QAAO,WAAW;WACzC,WAAW,SAAS,MAAO,QAAO;;CAG7C,SAAS,mBAAmB,YAA+B,SAAsB;EAC/E,MAAM,OAAsC,EAAE;EAC9C,MAAM,OAA+C,EAAE;EAEvD,eAAe,QAAQ,EAAE,MAAM,QAA4B;GACzD,IAAI,WAAW,MAAM,GAAG,SAAS,KAAK,SAAS,EAAE,UAAU;AAC3D,aAAU,WAAW,QAAQ,CAAC;GAE9B,MAAM,WAAW,MAAM,SAAS,MAAM,YAAY;IAChD,UAAU,KAAK;IACf,QAAQ;IACR,aAAa;IACb,eAAe;IACf,aAAa;IACd,CAAC;AAEF,UAAQ,MAAM,WAAW,OAAO,SAAS,MAAM,EAAE,EAC/C,SAAS,cAAc,KAAK,SAAS,EACtC,CAAC;;AAGJ,OAAK,MAAM,SAAS,SAAS;AAC3B,QAAK,MAAM,KAAK,cAAc,MAAM;GACpC,IAAI;AACJ,QAAK,MAAM,KAAK,cAAe,iBAAiB,QAAQ,MAAM;;AAGhE,SAAO;GAAE;GAAM;GAAM;;AAGvB,QAAO;EACL,MAAM,IACJ,MACA,MACA,SACA;GACA,MAAM,aAAa,iBAAiB,KAAe;AACnD,OAAI,CAAC,WAAY,OAAM,IAAI,MAAM,sBAAsB,KAAe,iBAAiB;GAEvF,MAAM,EAAE,MAAM,SAAS,mBAAmB,YAAY,QAAQ;AAE9D,UAAO,OAAO,QAAQ,MAAM,MAAM,MAAM,KAAK;;EAE/C,MAAM,KACJ,MACA,MACA,MACA,SACA;GACA,MAAM,aAAa,iBAAiB,KAAe;AACnD,OAAI,CAAC,WAAY,OAAM,IAAI,MAAM,sBAAsB,KAAe,iBAAiB;GAEvF,MAAM,OAAO,mBAAmB,YAAY,QAAQ;AACpD,UAAO,OAAO,SAAS,MAAM,MAAM,MAAM,KAAK,MAAM,KAAK,KAAK;;EAEjE"}