{"version":3,"file":"index.js","names":[],"sources":["../../src/vite/index.ts"],"sourcesContent":["import { mergeConfig, type Plugin, type UserConfig } from 'vite';\nimport { buildConfig } from '@/config/build';\nimport { ValidationError } from '@/utils/validation';\nimport { createMdxLoader } from '@/loaders/mdx';\nimport { toVite } from '@/loaders/adapter';\nimport type { FSWatcher } from 'chokidar';\nimport { _Defaults, createCore } from '@/core';\nimport { createIntegratedConfigLoader } from '@/loaders/config';\nimport { createMetaLoader } from '@/loaders/meta';\nimport indexFile, { IndexFilePluginOptions } from '@/plugins/index-file';\n\nexport interface PluginOptions {\n  /**\n   * Generate index files for accessing content.\n   *\n   * @defaultValue true\n   */\n  index?: boolean | IndexFilePluginOptions;\n\n  /**\n   * @defaultValue source.config.ts\n   */\n  configPath?: string;\n\n  /**\n   * Update Vite config to fix module resolution of Fumadocs\n   *\n   * @defaultValue true\n   */\n  updateViteConfig?: boolean;\n\n  /**\n   * Output directory of generated files\n   *\n   * @defaultValue '.source'\n   */\n  outDir?: string;\n}\n\nexport default async function mdx(\n  config: Record<string, unknown>,\n  pluginOptions: PluginOptions = {},\n): Promise<Plugin> {\n  const options = applyDefaults(pluginOptions);\n  const core = createViteCore(options);\n  await core.init({\n    config: buildConfig(config),\n  });\n\n  const configLoader = createIntegratedConfigLoader(core);\n  const mdxLoader = toVite(createMdxLoader(configLoader));\n  const metaLoader = toVite(\n    createMetaLoader(configLoader, {\n      // vite has built-in plugin for JSON files\n      json: 'json',\n    }),\n  );\n\n  return {\n    name: 'fumadocs-mdx',\n    // needed, otherwise other plugins will be executed before our `transform`.\n    enforce: 'pre',\n    config(config) {\n      if (!options.updateViteConfig) return config;\n\n      return mergeConfig(config, {\n        resolve: {\n          noExternal: ['fumadocs-core', 'fumadocs-ui', 'fumadocs-openapi', '@fumadocs/base-ui'],\n          // only dedupe for public, non-transitive libs\n          dedupe: ['fumadocs-core', 'fumadocs-ui', 'fumadocs-openapi', '@fumadocs/base-ui'],\n        },\n      } satisfies UserConfig);\n    },\n    async buildStart() {\n      await core.emit({ write: true });\n    },\n    async configureServer(server) {\n      await core.initServer({\n        watcher: server.watcher as unknown as FSWatcher,\n      });\n    },\n    async transform(value, id) {\n      try {\n        if (metaLoader.filter(id)) {\n          return await metaLoader.transform.call(this, value, id);\n        }\n\n        if (mdxLoader.filter(id)) {\n          return await mdxLoader.transform.call(this, value, id);\n        }\n      } catch (e) {\n        if (e instanceof ValidationError) {\n          throw new Error(await e.toStringFormatted(), { cause: e });\n        }\n\n        throw e;\n      }\n    },\n  };\n}\n\nexport async function postInstall(pluginOptions: PluginOptions = {}) {\n  const { loadConfig } = await import('@/config/load-from-file');\n  const core = createViteCore(applyDefaults(pluginOptions));\n  await core.init({\n    config: loadConfig(core, true),\n  });\n  await core.emit({ write: true });\n}\n\nfunction createViteCore({ index, configPath, outDir }: Required<PluginOptions>) {\n  if (index === true) index = {};\n\n  return createCore({\n    environment: 'vite',\n    configPath,\n    outDir,\n    plugins: [\n      index &&\n        indexFile({\n          ...index,\n          target: index.target ?? 'vite',\n        }),\n    ],\n  });\n}\n\nfunction applyDefaults(options: PluginOptions): Required<PluginOptions> {\n  return {\n    updateViteConfig: options.updateViteConfig ?? true,\n    index: options.index ?? true,\n    configPath: options.configPath ?? _Defaults.configPath,\n    outDir: options.outDir ?? _Defaults.outDir,\n  };\n}\n"],"mappings":";;;;;;;;;;;;AAuCA,eAA8B,IAC5B,QACA,gBAA+B,EAAE,EAChB;CACjB,MAAM,UAAU,cAAc,cAAc;CAC5C,MAAM,OAAO,eAAe,QAAQ;AACpC,OAAM,KAAK,KAAK,EACd,QAAQ,YAAY,OAAO,EAC5B,CAAC;CAEF,MAAM,eAAe,6BAA6B,KAAK;CACvD,MAAM,YAAY,OAAO,gBAAgB,aAAa,CAAC;CACvD,MAAM,aAAa,OACjB,iBAAiB,cAAc,EAE7B,MAAM,QACP,CAAC,CACH;AAED,QAAO;EACL,MAAM;EAEN,SAAS;EACT,OAAO,QAAQ;AACb,OAAI,CAAC,QAAQ,iBAAkB,QAAO;AAEtC,UAAO,YAAY,QAAQ,EACzB,SAAS;IACP,YAAY;KAAC;KAAiB;KAAe;KAAoB;KAAoB;IAErF,QAAQ;KAAC;KAAiB;KAAe;KAAoB;KAAoB;IAClF,EACF,CAAsB;;EAEzB,MAAM,aAAa;AACjB,SAAM,KAAK,KAAK,EAAE,OAAO,MAAM,CAAC;;EAElC,MAAM,gBAAgB,QAAQ;AAC5B,SAAM,KAAK,WAAW,EACpB,SAAS,OAAO,SACjB,CAAC;;EAEJ,MAAM,UAAU,OAAO,IAAI;AACzB,OAAI;AACF,QAAI,WAAW,OAAO,GAAG,CACvB,QAAO,MAAM,WAAW,UAAU,KAAK,MAAM,OAAO,GAAG;AAGzD,QAAI,UAAU,OAAO,GAAG,CACtB,QAAO,MAAM,UAAU,UAAU,KAAK,MAAM,OAAO,GAAG;YAEjD,GAAG;AACV,QAAI,aAAa,gBACf,OAAM,IAAI,MAAM,MAAM,EAAE,mBAAmB,EAAE,EAAE,OAAO,GAAG,CAAC;AAG5D,UAAM;;;EAGX;;AAGH,eAAsB,YAAY,gBAA+B,EAAE,EAAE;CACnE,MAAM,EAAE,eAAe,MAAM,OAAO;CACpC,MAAM,OAAO,eAAe,cAAc,cAAc,CAAC;AACzD,OAAM,KAAK,KAAK,EACd,QAAQ,WAAW,MAAM,KAAK,EAC/B,CAAC;AACF,OAAM,KAAK,KAAK,EAAE,OAAO,MAAM,CAAC;;AAGlC,SAAS,eAAe,EAAE,OAAO,YAAY,UAAmC;AAC9E,KAAI,UAAU,KAAM,SAAQ,EAAE;AAE9B,QAAO,WAAW;EAChB,aAAa;EACb;EACA;EACA,SAAS,CACP,SACE,UAAU;GACR,GAAG;GACH,QAAQ,MAAM,UAAU;GACzB,CAAC,CACL;EACF,CAAC;;AAGJ,SAAS,cAAc,SAAiD;AACtE,QAAO;EACL,kBAAkB,QAAQ,oBAAoB;EAC9C,OAAO,QAAQ,SAAS;EACxB,YAAY,QAAQ,cAAc,UAAU;EAC5C,QAAQ,QAAQ,UAAU,UAAU;EACrC"}