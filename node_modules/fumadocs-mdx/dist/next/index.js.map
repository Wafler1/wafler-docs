{"version":3,"file":"index.js","names":["path"],"sources":["../../src/next/index.ts"],"sourcesContent":["import type { NextConfig } from 'next';\nimport type { Configuration } from 'webpack';\nimport type { WebpackLoaderOptions } from '@/webpack';\nimport type { TurbopackLoaderOptions, TurbopackOptions } from 'next/dist/server/config-shared';\nimport * as path from 'node:path';\nimport { loadConfig } from '@/config/load-from-file';\nimport { _Defaults, type Core, createCore } from '@/core';\nimport { mdxLoaderGlob, metaLoaderGlob } from '@/loaders';\nimport type { IndexFilePluginOptions } from '@/plugins/index-file';\nimport indexFile from '@/plugins/index-file';\n\nexport interface CreateMDXOptions {\n  /**\n   * Path to source configuration file\n   */\n  configPath?: string;\n\n  /**\n   * Directory for output files\n   *\n   * @defaultValue '.source'\n   */\n  outDir?: string;\n\n  index?: IndexFilePluginOptions | false;\n}\n\nconst defaultPageExtensions = ['mdx', 'md', 'jsx', 'js', 'tsx', 'ts'];\n\nexport function createMDX(createOptions: CreateMDXOptions = {}) {\n  const core = createNextCore(applyDefaults(createOptions));\n  const isDev = process.env.NODE_ENV === 'development';\n\n  if (process.env._FUMADOCS_MDX !== '1') {\n    process.env._FUMADOCS_MDX = '1';\n\n    void init(isDev, core);\n  }\n\n  return (nextConfig: NextConfig = {}): NextConfig => {\n    const { configPath, outDir } = core.getOptions();\n    const loaderOptions: WebpackLoaderOptions = {\n      configPath,\n      outDir,\n      absoluteCompiledConfigPath: path.resolve(core.getCompiledConfigPath()),\n      isDev,\n    };\n\n    const turbopack: TurbopackOptions = {\n      ...nextConfig.turbopack,\n      rules: {\n        ...nextConfig.turbopack?.rules,\n        '*.{md,mdx}': {\n          loaders: [\n            {\n              loader: 'fumadocs-mdx/loader-mdx',\n              options: loaderOptions as unknown as TurbopackLoaderOptions,\n            },\n          ],\n          as: '*.js',\n        },\n        '*.json': {\n          loaders: [\n            {\n              loader: 'fumadocs-mdx/loader-meta',\n              options: loaderOptions as unknown as TurbopackLoaderOptions,\n            },\n          ],\n          as: '*.json',\n        },\n        '*.yaml': {\n          loaders: [\n            {\n              loader: 'fumadocs-mdx/loader-meta',\n              options: loaderOptions as unknown as TurbopackLoaderOptions,\n            },\n          ],\n          as: '*.js',\n        },\n      },\n    };\n\n    return {\n      ...nextConfig,\n      turbopack,\n      pageExtensions: nextConfig.pageExtensions ?? defaultPageExtensions,\n      webpack: (config: Configuration, options) => {\n        config.resolve ||= {};\n\n        config.module ||= {};\n        config.module.rules ||= [];\n\n        config.module.rules.push(\n          {\n            test: mdxLoaderGlob,\n            use: [\n              options.defaultLoaders.babel,\n              {\n                loader: 'fumadocs-mdx/loader-mdx',\n                options: loaderOptions,\n              },\n            ],\n          },\n          {\n            test: metaLoaderGlob,\n            enforce: 'pre',\n            use: [\n              {\n                loader: 'fumadocs-mdx/loader-meta',\n                options: loaderOptions,\n              },\n            ],\n          },\n        );\n\n        config.plugins ||= [];\n\n        return nextConfig.webpack?.(config, options) ?? config;\n      },\n    };\n  };\n}\n\nasync function init(dev: boolean, core: Core): Promise<void> {\n  async function initOrReload() {\n    await core.init({\n      config: loadConfig(core, true),\n    });\n    await core.emit({ write: true });\n  }\n\n  async function devServer() {\n    const { FSWatcher } = await import('chokidar');\n    const { configPath, outDir } = core.getOptions();\n    const watcher = new FSWatcher({\n      ignoreInitial: true,\n      persistent: true,\n      ignored: [outDir],\n    });\n\n    watcher.add(configPath);\n    for (const collection of core.getCollections()) {\n      watcher.add(collection.dir);\n    }\n    for (const workspace of core.getWorkspaces().values()) {\n      for (const collection of workspace.getCollections()) {\n        watcher.add(collection.dir);\n      }\n    }\n\n    watcher.on('ready', () => {\n      console.log('[MDX] started dev server');\n    });\n\n    const absoluteConfigPath = path.resolve(configPath);\n    watcher.on('all', async (_event, file) => {\n      if (path.resolve(file) === absoluteConfigPath) {\n        // skip plugin listeners\n        watcher.removeAllListeners();\n\n        await watcher.close();\n        await initOrReload();\n        console.log('[MDX] restarting dev server');\n        await devServer();\n      }\n    });\n\n    process.on('exit', () => {\n      if (watcher.closed) return;\n\n      console.log('[MDX] closing dev server');\n      void watcher.close();\n    });\n\n    await core.initServer({ watcher });\n  }\n\n  await initOrReload();\n  if (dev) {\n    await devServer();\n  }\n}\n\nexport async function postInstall(options: CreateMDXOptions) {\n  const core = createNextCore(applyDefaults(options));\n  await core.init({\n    config: loadConfig(core, true),\n  });\n  await core.emit({ write: true });\n}\n\nfunction applyDefaults(options: CreateMDXOptions): Required<CreateMDXOptions> {\n  return {\n    index: {},\n    outDir: options.outDir ?? _Defaults.outDir,\n    configPath: options.configPath ?? _Defaults.configPath,\n  };\n}\n\nfunction createNextCore(options: Required<CreateMDXOptions>): Core {\n  return createCore({\n    environment: 'next',\n    outDir: options.outDir,\n    configPath: options.configPath,\n    plugins: [options.index && indexFile(options.index)],\n  });\n}\n"],"mappings":"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"}